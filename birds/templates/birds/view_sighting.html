{% extends 'birds/base.html' %}



{% block content %}

{% if error_message %}
	<div class="mdl-components__warning">
		<b>Note:</b> {{ error_message }}
	</div>
{% endif %}

<div class="mdl-grid" id="view-sighting-main-grid">
	{% if sighting.images.count == 0 %}
		<div class="hover-card mdl-cell mdl-cell--12-col-desktop mdl-cell--12-col-tablet demo-card-wide mdl-card mdl-shadow--2dp">
			<div style="height:100px;" class="image image-block-m mdl-color--blue-grey-800">
				<h4 style="top:0px;" >
					<span>{{ sighting.caption }}</span>
				</h4>
				<div class="mdl-card__actions index-species-tag">
					<span>
						<i class="material-icons">local_offer</i><span> {{sighting.species_tag}}</span>
					</span>
				</div>
			</div>
		</div>
	{% else %}
		{% for image in sighting.images %}
			{% if forloop.counter == 1 %}
				<div class="hover-card mdl-cell mdl-cell--12-col-desktop mdl-cell--12-col-tablet demo-card-wide mdl-card mdl-shadow--2dp">
					<a href="#" class="image-expand-on-click" data-image_id="{{ image.id }}">
						<div class="image image-block-m sighting-page" style="background: url({{ image.photo.url }}) no-repeat center;background-size:cover;">
						<h4>
							<span>{{ sighting.caption }}</span>
						</h4>
						</div>
					</a>
				</div>
			{% else %}
				<div class="hover-card mdl-cell mdl-cell--3-col-desktop mdl-cell--4-col-tablet mdl-cell--2-col-phone mdl-shadow--2dp">
					<a href="#" class="image-expand-on-click" data-image_id="{{ image.id }}">
						<div class="image image-block-m sighting-page sub-image" style="background: url({{ image.photo.url }}) no-repeat center;background-size:cover;"></div>
					</a>
				</div>
			{% endif %}
		{% endfor %}
	{% endif %}
	</div>
	<div class=mdl-grid>
    <div class="mdl-cell mdl-cell--8-col-desktop mdl-cell--4-col-tablet mdl-cell--4-col-phone demo-card-wide mdl-card mdl-shadow--2dp">
        <div class="mdl-card__title">
            <h2 class="mdl-card__title-text">{{ sighting.sighting_date }}</h2>
        </div>
        <div class="mdl-card__supporting-text">
            <i class="material-icons">local_offer</i><b> {{ sighting.species_tag }}</b>
			<span id="num_votes">
				{{ species_votes }}

			</span>

			{% if user.is_authenticated %}
				{% if is_voted > 0 %}
					<button data-species_tag-id="{{ sighting.species_tag.id }}" class="up_vote_species mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect" style="display:none">
						<i class="material-icons md-light">expand_less</i>
					</button>
					<button data-species_tag-id="{{ sighting.species_tag.id }}" class="down_vote_species mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect" id="down_vote_species">
						<i class="material-icons md-light">expand_more</i>
					</button>
				{% else %}
					<button data-species_tag-id="{{ sighting.species_tag.id }}" class="up_vote_species mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect" id="up_vote_species">
						<i class="material-icons md-light">expand_less</i>
					</button>
					<button data-species_tag-id="{{ sighting.species_tag.id }}" class="down_vote_species mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect" id="down_vote_species" style="display:none">
						<i class="material-icons md-light">expand_more</i>
					</button>
				{% endif %}
				<div class="mdl-tooltip" for="up_vote_species">
					agree
				</div>
				<div class="mdl-tooltip" for="down_vote_species">
					undo agree
				</div>
				<button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect" id="suggest_species">
					<i class="material-icons md-light">add</i>
				</button>
				<div class="mdl-tooltip" for="suggest_species">
					suggest species
				</div>
				<form id="new_species_form" style="display:none">
					<div class="mdl-textfield mdl-js-textfield">
						<input style="width:100%" class="mdl-textfield__input" name="new_species" id="new_species_input"></input>
						<label class="mdl-textfield__label" for="new_species">new species</label>
						<input id="id_species_tag" name="species_id" type="hidden">
					</div>
					{% csrf_token %}
					<input name="sighting_id" value="{{ sighting.id }}" type="hidden"></input>
					<button type="button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="new_species_save_button">Submit</button>
					<button type="button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--accent" id="new_species_cancel_button">Cancel</button>
				</form>
			{% endif %}<br><br><a target="_blank" href="http://www.wikipedia.com"><b>Bird</b></a>
			 <div class="mdl-card__supporting-text" id="species_suggestion_info">

			 </div>
        </div>
        <div class="mdl-card__supporting-text">
            {{ sighting.post_text }}
        </div>
		<div class="mdl-card__menu md-light">
			{% if user.is_authenticated %}
				<span id="num_likes">
					{% if sighting.num_likes == 1 %}
						{{ sighting.num_likes }} like
					{% elif sighting.num_likes > 1 %}
						{{ sighting.num_likes }} likes
					{% endif %}
				</span>
				{% if is_liked > 0 %}
				<button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect" id="unlike_button">
				  <i class="material-icons md-light">star</i>
				</button>
				<button style="display:none" class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect" id="like_button">
				  <i class="material-icons md-light">star_border</i>
				</button>
				{% else %}
				<button style="display:none" class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect" id="unlike_button">
				  <i class="material-icons md-light">star</i>
				</button>
				<button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect" id="like_button">
				  <i class="material-icons md-light">star_border</i>
				</button>
				{% endif %}
				<div class="mdl-tooltip" for="like_button">
					like
				</div>
				<div class="mdl-tooltip" for="unlike_button">
					lnlike
				</div>
				
				<button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect index-card-buttons" id="flag_post">
				  <i class="material-icons md-light">flag</i>			      
				</button>
				<div class="mdl-tooltip" for="flag_post">
					flag post
				</div>
				{% if sighting.user_id == user.id %}
				<button id="edit_button" class="mdl-button md-light mdl-button--icon mdl-js-button mdl-js-ripple-effect index-card-buttons">
					<i class="material-icons md-light">mode_edit</i>
				</button>
				<div class="mdl-tooltip" for="edit_button">
					edit post
				</div>
				{% endif %}
			{% endif %}
        </div>
    </div>
	<div class="mdl-cell mdl-cell--4-col-desktop mdl-cell--4-col-tablet mdl-cell--4-col-phone demo-card-wide mdl-card mdl-shadow--2dp">
        <div id="map"></div>
    </div>
   
	<div class="mdl-cell mdl-cell--12-col-desktop mdl-cell--12-col-tablet demo-card-wide mdl-card mdl-shadow--2dp">
		<div class="mdl-card__title">
			<h2 class="mdl-card__title-text">Comments</h2>
		</div>
        <div class="mdl-card__supporting-text comments-chain" id="existing_comments"></div>
		{% if user.is_authenticated %}
        <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="reveal-comments">Comment</button>
		<div class="mdl-card__actions mdl-card--border" id="save-comment-block" style="display:none">
			<form id="new_comment_form">
				<div style="width:100%" class="mdl-textfield mdl-js-textfield">
					<textarea style="width:100%" class="mdl-textfield__input" type="text" rows= "3" name="new_comment" id="new_comment_input" ></textarea>
					<label class="mdl-textfield__label" for="new_comment">New comment...</label>
				</div>
				{% csrf_token %}
				<input name="sighting_id" value="{{ sighting.id }}" type="hidden"></input>
			</form>
			<button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="new_comment_save_button">Post</button>
			<button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="new_comment_cancel_button">Cancel</button>
		</div>
		{% endif %}
	</div>
</div>

<script type="text/javascript">
    jQuery(function($){
		$('body').append('<div id="image_inspect_test"><div style="position:absolute"><a id="close_image_inspect" href="" onclick="return false;"><i class="material-icons">close</i></a></div><div id="image_inspect_content"></div></div>');
	
		$('.image-expand-on-click').click(function(){
			var image_id = $(this).attr('data-image_id');
			$('#image_inspect_content').load(
				"{% url 'birds:image_inspect' %}",
				{'image_id': image_id, 'csrfmiddlewaretoken': '{{ csrf_token }}'}
			);
			$('#image_inspect_test').toggle();
		});
		
		$('#close_image_inspect').click(function(){
			$('#image_inspect_test').toggle();
		});
		
        $('#edit_button').click(function(){
			window.location = "{% url 'birds:edit_sighting' sighting.id %}";
		})
		
		var pos = { lat: {{ sighting.lat|default:0 }}, lng: {{ sighting.lng|default:0 }} }
        var map = new google.maps.Map(document.getElementById('map'), { zoom: 10, center: pos })
		var marker = new google.maps.Marker({
            position: pos, icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 5
            },
            draggable: false,
            map: map
        })
		
		function load_comments() {
			$.ajax({
				url: "{% url 'birds:get_comments' %}",
				data: {'this_sighting': {{ sighting.id }}, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
				type: "POST",
				dataType: "html",
				success: function(data) {
					$("#existing_comments").html(data);
				}
			});
		}
		
		load_comments();
		
		function load_species_suggestions() {
			$.ajax({
				url: "{% url 'birds:get_species_suggestions' %}",
				data: {'sighting_id': {{ sighting.id }}, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
				type: "POST",
				dataType: "html",
				success: function(data) {
					$('#species_suggestion_info').html(data);
					init_species_vote_buttons();
				}
			});
		}
		
		load_species_suggestions();
		
		{% if user.is_authenticated %}
		$('#new_species_input').autocomplete({
			source: "{% url 'birds:species_query' %}",
			minLength: 2,
			response: function( event, ui ) {
			
				//alert('got response');
			
			},
			select: function( event, ui ){
				$('#id_species_tag').val(ui.item.id);
			}
		});
		
		$('#reveal-comments').click(function(){
			$('#save-comment-block').slideToggle("slow");
			$(this).slideToggle("fast");
		});
		
		$('#new_comment_cancel_button').click(function(){
			$('#save-comment-block').slideToggle("fast");
			$('#reveal-comments').slideToggle("slow");
		});
		
		$('#new_comment_save_button').click(function(){
			$.ajax({
				url: "{% url 'birds:new_comment' %}",
				data: $('#new_comment_form').serialize(),
				type: "POST",
				dataType: "json",
				success: function(data) {
					load_comments();
					$('#new_comment_input').val("");
					$('#new_comment_input').parent().removeClass('is-dirty');
				},
				error: function(jqXHR, textStatus, errorThrown){
					alert(textStatus);
				}
			});
		
		});
		
		$('#like_button,#unlike_button').click(function(){
			if ( $(this).attr('id') == "like_button" ) {
				var url_location = "{% url 'birds:like' %}"
			}else{
				var url_location = "{% url 'birds:unlike' %}"
			}
			$.ajax({
				url: url_location,
				data: {'sighting_id': {{ sighting.id }}, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
				type: "POST",
				dataType: "json",
				success: function(data) {
					$('#like_button,#unlike_button').toggle();
					if ( 'new_likes' in data ){
						if ( data.new_likes == 1) {
							$('#num_likes').text("1 like");
						}else if ( data.new_likes > 1 ) {
							$('#num_likes').text(data.new_likes+" like");
						}else{
							$('#num_likes').text("");
						}
					}
				},
				error: function(jqXHR, textStatus, errorThrown){
					alert(textStatus);
				}
			});
		});
		
		function init_species_vote_buttons() {
			$('.up_vote_species,.down_vote_species').click(function(){
				if ( $(this).hasClass("up_vote_species") ) {
					var url_location = "{% url 'birds:up_vote_species' %}"
				}else{
					var url_location = "{% url 'birds:down_vote_species' %}"
				}
				$.ajax({
					url: url_location,
					data: {
						'sighting_id': {{ sighting.id }},
						'species_id': $(this).attr("data-species_tag-id"),
						'csrfmiddlewaretoken': '{{ csrf_token }}'
					},
					type: "POST",
					dataType: "json",
					success: function(data) {
						$('.up_vote_species[data-species_tag-id="'+data.species_id+'"],.down_vote_species[data-species_tag-id="'+data.species_id+'"]').toggle();
						if ( 'new_votes' in data ){
							$('#'+data.species_id+'_num_votes').text(data.new_votes);
						}
					},
					error: function(jqXHR, textStatus, errorThrown){
						alert(textStatus);
					}
				});
			});
		}
		
		$('#suggest_species,#new_species_cancel_button').click(function(){
			$('#new_species_form').slideToggle();
			$('#suggest_species').slideToggle();
		});
		
		$('#new_species_save_button').click(function(){
			$.ajax({
				url: "{% url 'birds:suggest_new_species' %}",
				data: $('#new_species_form').serialize(),
				type: "POST",
				dataType: "json",
				success: function(data) {
					load_species_suggestions();
					$('#new_species_form').slideToggle();
				},
				error: function(jqXHR, textStatus, errorThrown){
					alert(textStatus);
				}
			});
		
		});
		{% endif %}
		
    })
</script>

{% endblock %}
